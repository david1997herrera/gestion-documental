{% extends "base.html" %}

{% block title %}Mi Dashboard - Gestión Documental{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="user-header" data-aos="fade-down">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h1 class="user-name">¡Hola, {{ current_user.username }}!</h1>
                        <p class="user-role">
                            <span class="badge bg-primary">{{ current_user.role.title() }}</span>
                            <span class="badge bg-secondary">{{ current_user.area }}</span>
                        </p>
                    </div>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-number">{{ user_tasks|length }}</span>
                        <span class="stat-label">Tareas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ user_tasks|selectattr('status', 'equalto', 'completed')|list|length }}</span>
                        <span class="stat-label">Completadas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ unread_notifications|length }}</span>
                        <span class="stat-label">Notificaciones</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    {% if unread_notifications %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="notifications-card" data-aos="fade-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bell me-2"></i>Notificaciones Recientes
                        <span class="badge bg-danger ms-2">{{ unread_notifications|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% for notification in unread_notifications %}
                    <div class="notification-item">
                        <div class="notification-icon">
                            <i class="fas fa-{{ 'exclamation-triangle' if 'expirada' in notification.title else 'info-circle' }}"></i>
                        </div>
                        <div class="notification-content">
                            <h6 class="notification-title">{{ notification.title }}</h6>
                            <p class="notification-message">{{ notification.message }}</p>
                            <small class="notification-time">
                                <i class="fas fa-clock me-1"></i>
                                {{ notification.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </small>
                        </div>
                        <div class="notification-actions">
                            <a href="{{ url_for('mark_notification_read', notification_id=notification.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-check"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- My Tasks -->
    <div class="row">
        <div class="col-12">
            <div class="tasks-card" data-aos="fade-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Mis Tareas Asignadas
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_tasks %}
                        <div class="row">
                            {% for task in user_tasks %}
                            <div class="col-lg-6 col-xl-4 mb-4">
                                <div class="task-card" data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}">
                                    <div class="task-header">
                                        <div class="task-status">
                                            {% if task.status == 'completed' %}
                                                <span class="status-badge completed">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                            {% elif task.status == 'in_progress' %}
                                                <span class="status-badge in-progress">
                                                    <i class="fas fa-clock"></i>
                                                </span>
                                            {% elif task.status == 'expired' %}
                                                <span class="status-badge expired">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </span>
                                            {% else %}
                                                <span class="status-badge pending">
                                                    <i class="fas fa-pending"></i>
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="task-category">
                                            <span class="badge bg-secondary">{{ task.document.category.name }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="task-content">
                                        <h6 class="task-title">{{ task.document.title }}</h6>
                                        <p class="task-description">{{ task.document.description[:100] }}{% if task.document.description|length > 100 %}...{% endif %}</p>
                                        
                                        {% if task.due_date %}
                                        <div class="task-deadline">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            <span class="{% if is_task_overdue(task.due_date, task.status) %}text-danger{% else %}text-muted{% endif %}">
                                                Vence: {{ task.due_date.strftime('%d/%m/%Y') }}
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if task.notes %}
                                        <div class="task-notes">
                                            <i class="fas fa-sticky-note me-1"></i>
                                            <small class="text-muted">{{ task.notes[:50] }}{% if task.notes|length > 50 %}...{% endif %}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="task-actions">
                                        {% if task.status == 'pending' or task.status == 'in_progress' %}
                                            <a href="{{ url_for('upload_document', task_id=task.id) }}" 
                                               class="btn btn-primary btn-sm">
                                                <i class="fas fa-upload me-1"></i>Subir Documento
                                            </a>
                                        {% elif task.status == 'completed' %}
                                            <button class="btn btn-success btn-sm" disabled>
                                                <i class="fas fa-check me-1"></i>Completado
                                            </button>
                                        {% else %}
                                            <button class="btn btn-danger btn-sm" disabled>
                                                <i class="fas fa-exclamation-triangle me-1"></i>Expirado
                                            </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-outline-info btn-sm" onclick="viewTaskDetails({{ task.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <h5>¡No tienes tareas asignadas!</h5>
                            <p class="text-muted">Cuando se te asignen tareas, aparecerán aquí.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de la Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailsModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
.user-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.user-info {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.user-avatar {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-right: 1.5rem;
}

.user-name {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.user-role .badge {
    margin-right: 0.5rem;
    font-size: 0.9rem;
}

.header-stats {
    display: flex;
    justify-content: space-around;
}

.stat-item {
    text-align: center;
}

.stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.notifications-card, .tasks-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px 15px 0 0;
    padding: 1.5rem;
    border-bottom: none;
}

.notification-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: white;
}

.notification-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #333;
}

.notification-message {
    color: #666;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.notification-time {
    color: #999;
    font-size: 0.8rem;
}

.task-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    height: 100%;
    border-left: 4px solid #667eea;
}

.task-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.status-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: white;
}

.status-badge.completed { background: #28a745; }
.status-badge.in-progress { background: #ffc107; }
.status-badge.expired { background: #dc3545; }
.status-badge.pending { background: #6c757d; }

.task-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
}

.task-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.task-deadline, .task-notes {
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.task-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.task-actions .btn {
    flex: 1;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
}

.empty-icon {
    font-size: 4rem;
    color: #ddd;
    margin-bottom: 1rem;
}

@media (max-width: 768px) {
    .user-info {
        flex-direction: column;
        text-align: center;
    }
    
    .user-avatar {
        margin-right: 0;
        margin-bottom: 1rem;
    }
    
    .header-stats {
        flex-direction: column;
        gap: 1rem;
    }
    
    .notification-item {
        flex-direction: column;
        text-align: center;
    }
    
    .notification-icon {
        margin-right: 0;
        margin-bottom: 1rem;
    }
}
</style>

<script>
function viewTaskDetails(taskId) {
    // Implementar vista de detalles de la tarea
    alert(`Vista de detalles para la tarea: ${taskId}`);
}

// Auto-refresh notifications every 30 seconds
setInterval(function() {
    if (document.querySelector('.notifications-card')) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}
